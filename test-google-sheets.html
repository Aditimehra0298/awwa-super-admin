<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>Google Sheets Integration Test</h1>
    
    <div class="test-section">
        <h2>Test Configuration</h2>
        <p><strong>Sheet ID:</strong> 1xc4yFUKCHt3_arojTCzc8lf3fGmaco8TzTTJ-HCwpFw</p>
        <p><strong>Sheet Name:</strong> Family Details (Ranbankura Eagles)</p>
    </div>
    
    <div class="test-section">
        <h2>Test Actions</h2>
        <button class="test-button" onclick="testDirectFetch()">Test Direct Fetch</button>
        <button class="test-button" onclick="testCorsProxy()">Test CORS Proxy</button>
        <button class="test-button" onclick="testCSVParsing()">Test CSV Parsing</button>
        <button class="test-button" onclick="clearResults()">Clear Results</button>
    </div>
    
    <div class="test-section">
        <h2>Results</h2>
        <div id="results"></div>
    </div>

    <script>
        const GOOGLE_SHEET_ID = '1xc4yFUKCHt3_arojTCzc8lf3fGmaco8TzTTJ-HCwpFw';
        const GOOGLE_SHEET_NAME = 'Family Details (Ranbankura Eagles)';
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testDirectFetch() {
            addResult('Testing direct fetch...', 'info');
            try {
                const sheetUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(GOOGLE_SHEET_NAME)}`;
                addResult(`Fetching: ${sheetUrl}`, 'info');
                
                const response = await fetch(sheetUrl);
                addResult(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const text = await response.text();
                    addResult(`Response length: ${text.length} characters`, 'success');
                    addResult(`First 500 chars:\n${text.substring(0, 500)}`, 'info');
                } else {
                    addResult(`Error: ${response.statusText}`, 'error');
                }
            } catch (error) {
                addResult(`Error: ${error.message}`, 'error');
            }
        }
        
        async function testCorsProxy() {
            addResult('Testing CORS proxy...', 'info');
            try {
                const sheetUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(GOOGLE_SHEET_NAME)}`;
                
                // Try multiple CORS proxies
                const proxies = [
                    'https://api.allorigins.win/raw?url=',
                    'https://cors-anywhere.herokuapp.com/',
                    'https://api.codetabs.com/v1/proxy?quest=',
                    'https://thingproxy.freeboard.io/fetch/'
                ];
                
                let success = false;
                let lastError = '';
                
                for (let i = 0; i < proxies.length; i++) {
                    try {
                        const proxyUrl = proxies[i] + encodeURIComponent(sheetUrl);
                        addResult(`Trying proxy ${i + 1}: ${proxyUrl}`, 'info');
                        
                        const response = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/csv,text/plain,*/*',
                            }
                        });
                        
                        if (response.ok) {
                            const text = await response.text();
                            addResult(`Proxy ${i + 1} successful!`, 'success');
                            addResult(`Response length: ${text.length} characters`, 'success');
                            addResult(`First 500 chars:\n${text.substring(0, 500)}`, 'info');
                            success = true;
                            break;
                        } else {
                            addResult(`Proxy ${i + 1} failed: ${response.status} ${response.statusText}`, 'error');
                        }
                    } catch (proxyError) {
                        addResult(`Proxy ${i + 1} error: ${proxyError.message}`, 'error');
                        lastError = proxyError.message;
                    }
                }
                
                if (!success) {
                    addResult(`All proxies failed. Last error: ${lastError}`, 'error');
                }
            } catch (error) {
                addResult(`Error: ${error.message}`, 'error');
            }
        }
        
        async function testCSVParsing() {
            addResult('Testing CSV parsing...', 'info');
            try {
                const sheetUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(GOOGLE_SHEET_NAME)}`;
                
                // Try multiple CORS proxies
                const proxies = [
                    'https://api.allorigins.win/raw?url=',
                    'https://cors-anywhere.herokuapp.com/',
                    'https://api.codetabs.com/v1/proxy?quest=',
                    'https://thingproxy.freeboard.io/fetch/'
                ];
                
                let csvText = '';
                let success = false;
                
                for (let i = 0; i < proxies.length; i++) {
                    try {
                        const proxyUrl = proxies[i] + encodeURIComponent(sheetUrl);
                        addResult(`Trying proxy ${i + 1} for parsing...`, 'info');
                        
                        const response = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/csv,text/plain,*/*',
                            }
                        });
                        
                        if (response.ok) {
                            csvText = await response.text();
                            addResult(`Proxy ${i + 1} successful for parsing!`, 'success');
                            success = true;
                            break;
                        } else {
                            addResult(`Proxy ${i + 1} failed: ${response.status}`, 'error');
                        }
                    } catch (proxyError) {
                        addResult(`Proxy ${i + 1} error: ${proxyError.message}`, 'error');
                    }
                }
                
                if (!success) {
                    addResult('All proxies failed for parsing', 'error');
                    return;
                }
                
                const families = parseFamiliesCSV(csvText);
                
                addResult(`Parsed ${families.length} families`, 'success');
                if (families.length > 0) {
                    addResult(`First family: ${JSON.stringify(families[0], null, 2)}`, 'info');
                }
            } catch (error) {
                addResult(`Error: ${error.message}`, 'error');
            }
        }
        
        // Updated CSV parsing function for actual Google Sheets format
        function parseFamiliesCSV(csvText) {
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    console.warn('CSV has less than 2 lines');
                    return [];
                }
                
                // Parse CSV with proper handling of quoted fields
                function parseCSVLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.trim());
                    return result;
                }
                
                const headers = parseCSVLine(lines[0]);
                console.log('CSV Headers:', headers);
                console.log('Total lines:', lines.length);
                
                // Log all column names that might contain husband information
                const husbandColumns = headers.filter(h => 
                    h.toLowerCase().includes('husband') || 
                    h.toLowerCase().includes('spouse')
                );
                console.log('Husband-related columns:', husbandColumns);
                
                // Log all headers to see the exact format
                console.log('All headers:', headers.map((h, i) => `${i}: "${h}"`));
                
                const families = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = parseCSVLine(line);
                    
                    // Skip if we don't have enough values or if it's a header row
                    if (values.length < headers.length || values[0] === 'WKSP') {
                        continue;
                    }
                    
                    const family = {};
                    headers.forEach((header, index) => {
                        family[header.toLowerCase().replace(/\s+/g, '_')] = values[index] || '';
                    });
                    
                    // Map to our expected format using exact column names from the sheet
                    const ladyName = family.personal_information_ladies_name || '';
                    // Use the exact column name from the CSV headers
                    const husbandName = family.husbands_details_husbands_name || '';
                    const mobile = family.personal_mobile || '';
                    const qualification = family.highest_qualification || '';
                    const bloodGroup = family.blood_group || '';
                    const religion = family.religion || '';
                    const marriageDate = family.date_of_marriage || '';
                    const yearsInMarriage = family.years_in_marriage || '';
                    const email = family.personal_email || '';
                    const languages = family.languages_known || '';
                    const canDrive = family.can_drive || '';
                    const ownsVehicle = family.owns_vehicle || '';
                    const husbandRank = family.husbands_rank || '';
                    const unit = family.unit || '';
                    const subUnit = family.sub_unit || '';
                    const postingStation = family.posting_station || '';
                    const dateOfPosting = family.date_of_posting || '';
                    const quarterNumber = family.quarter_number || '';
                    const colonyName = family.colony_enclave_name || '';
                    const accommodationType = family.type_of_accommodation || '';
                    const accommodationAddress = family.family_accommodation_address || '';
                    
                    // Debug logging for husband name
                    if (ladyName && ladyName.trim()) {
                        console.log('Family:', ladyName, 'Husband data:', {
                            husbands_details_husbands_name: family.husbands_details_husbands_name,
                            husbands_name: family.husbands_name,
                            husband_name: family.husband_name,
                            husband: family.husband,
                            final: husbandName
                        });
                    }
                    
                    // Only add if we have at least a lady's name
                    if (ladyName && ladyName.trim()) {
                        families.push({
                            id: families.length + 1,
                            name: ladyName.trim(),
                            husband: husbandName.trim() || 'N/A',
                            contact: mobile.trim() || 'N/A',
                            education: qualification.trim() || 'N/A',
                            children: yearsInMarriage.trim() || 'N/A',
                            joined: marriageDate.trim() || 'N/A',
                            // Additional fields from the sheet
                            email: email.trim() || 'N/A',
                            bloodGroup: bloodGroup.trim() || 'N/A',
                            religion: religion.trim() || 'N/A',
                            languages: languages.trim() || 'N/A',
                            canDrive: canDrive.trim() || 'N/A',
                            ownsVehicle: ownsVehicle.trim() || 'N/A',
                            husbandRank: husbandRank.trim() || 'N/A',
                            unit: unit.trim() || 'N/A',
                            subUnit: subUnit.trim() || 'N/A',
                            postingStation: postingStation.trim() || 'N/A',
                            dateOfPosting: dateOfPosting.trim() || 'N/A',
                            quarterNumber: quarterNumber.trim() || 'N/A',
                            colonyName: colonyName.trim() || 'N/A',
                            accommodationType: accommodationType.trim() || 'N/A',
                            accommodationAddress: accommodationAddress.trim() || 'N/A'
                        });
                    }
                }
                
                console.log(`Parsed ${families.length} families from CSV`);
                return families;
                
            } catch (error) {
                console.error('Error parsing CSV:', error);
                return [];
            }
        }
    </script>
</body>
</html>
